<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Admin - Streaming</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 16px;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .github-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .github-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .episode-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .episode-group h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .add-episode-btn {
            background: #28a745;
            margin-top: 10px;
            width: auto;
            padding: 10px 20px;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .instructions h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
            color: #856404;
        }

        .small-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Portal de Administraci√≥n</h1>
            <p>Gestiona pel√≠culas y series f√°cilmente</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('login')">üîê Iniciar Sesi√≥n</button>
            <button class="tab" onclick="showTab('movies')" id="movieTab" style="display:none;">üé¨ A√±adir Pel√≠cula</button>
            <button class="tab" onclick="showTab('series')" id="seriesTab" style="display:none;">üì∫ A√±adir Serie</button>
        </div>

        <div class="content">
            <div id="alert" class="alert"></div>

            <!-- TAB: Login -->
            <div id="login" class="tab-content active">
                <div class="github-section">
                    <h3>üîê Autenticaci√≥n</h3>
                    <p style="margin-bottom: 20px;">Ingresa tu token de GitHub para comenzar. El token se guardar√° solo durante esta sesi√≥n.</p>
                    <div class="form-group">
                        <label>Token de GitHub:</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        <p class="small-text">Se guardar√° solo en esta sesi√≥n del navegador</p>
                    </div>
                    <button class="btn" onclick="login()">üöÄ Acceder al Portal</button>
                </div>
            </div>

            <!-- TAB: A√±adir Pel√≠cula -->
            <div id="movies" class="tab-content">
                <h2>üé¨ A√±adir Nueva Pel√≠cula</h2>
                <form id="movieForm" onsubmit="addMovie(event)">
                    <div class="form-group">
                        <label>Nombre de la Pel√≠cula:</label>
                        <input type="text" id="movieName" required placeholder="Ej: Shrek (2001)">
                    </div>
                    <div class="form-group">
                        <label>URL del P√≥ster:</label>
                        <input type="url" id="movieIcon" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Calificaci√≥n (0-10):</label>
                        <input type="number" id="movieRating" step="0.1" min="0" max="10" placeholder="7.9">
                    </div>
                    <div class="form-group">
                        <label>URL del Video (Archive.org o similar):</label>
                        <input type="url" id="movieSource" required placeholder="https://archive.org/download/...">
                    </div>
                    <div class="form-group">
                        <label>Formato (extensi√≥n):</label>
                        <select id="movieExt">
                            <option value="mp4">MP4</option>
                            <option value="mkv">MKV</option>
                            <option value="avi">AVI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <textarea id="moviePlot" placeholder="Descripci√≥n de la pel√≠cula..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Director:</label>
                        <input type="text" id="movieDirector" placeholder="Nombre del director">
                    </div>
                    <div class="form-group">
                        <label>Actores:</label>
                        <input type="text" id="movieActors" placeholder="Actor 1, Actor 2, Actor 3...">
                    </div>
                    <div class="form-group">
                        <label>G√©nero:</label>
                        <input type="text" id="movieGenre" placeholder="Acci√≥n, Aventura, Comedia...">
                    </div>
                    <div class="form-group">
                        <label>A√±o:</label>
                        <input type="number" id="movieYear" placeholder="2024">
                    </div>
                    <button type="submit" class="btn">‚ûï A√±adir Pel√≠cula a GitHub</button>
                </form>
            </div>

            <!-- TAB: A√±adir Serie -->
            <div id="series" class="tab-content">
                <h2>üì∫ A√±adir Nueva Serie</h2>
                <form id="seriesForm" onsubmit="addSeries(event)">
                    <div class="form-group">
                        <label>Nombre de la Serie:</label>
                        <input type="text" id="seriesName" required placeholder="Ej: Breaking Bad">
                    </div>
                    <div class="form-group">
                        <label>URL del P√≥ster:</label>
                        <input type="url" id="seriesCover" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Sinopsis:</label>
                        <textarea id="seriesPlot" required placeholder="Descripci√≥n de la serie..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Reparto:</label>
                        <input type="text" id="seriesCast" placeholder="Actor 1, Actor 2...">
                    </div>
                    <div class="form-group">
                        <label>Director:</label>
                        <input type="text" id="seriesDirector" placeholder="Nombre del director">
                    </div>
                    <div class="form-group">
                        <label>G√©nero:</label>
                        <input type="text" id="seriesGenre" placeholder="Drama, Thriller...">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Estreno:</label>
                        <input type="date" id="seriesRelease">
                    </div>
                    <div class="form-group">
                        <label>Calificaci√≥n (0-10):</label>
                        <input type="number" id="seriesRating" step="0.1" min="0" max="10" placeholder="8.5">
                    </div>
                    <div class="form-group">
                        <label>Duraci√≥n por episodio (minutos):</label>
                        <input type="number" id="seriesDuration" placeholder="45">
                    </div>

                    <div id="seasonsContainer"></div>
                    <button type="button" class="btn add-episode-btn" onclick="addSeason()">‚ûï A√±adir Temporada</button>
                    
                    <button type="submit" class="btn">‚ûï A√±adir Serie a GitHub</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de GitHub (se carga desde sessionStorage)
        let GITHUB_CONFIG = {
            token: '',
            user: 'Demo-159',
            repo: 'Xtream',
            branch: 'main',
            path: 'server.js'
        };

        let seasons = [];

        function login() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                showAlert('‚ö†Ô∏è Por favor ingresa tu token de GitHub', 'error');
                return;
            }
            
            GITHUB_CONFIG.token = token;
            sessionStorage.setItem('gh_token', token);
            
            document.getElementById('movieTab').style.display = 'block';
            document.getElementById('seriesTab').style.display = 'block';
            
            showAlert('‚úÖ Sesi√≥n iniciada correctamente', 'success');
            setTimeout(() => showTab('movies'), 1000);
        }

        function checkSession() {
            const token = sessionStorage.getItem('gh_token');
            if (token) {
                GITHUB_CONFIG.token = token;
                document.getElementById('movieTab').style.display = 'block';
                document.getElementById('seriesTab').style.display = 'block';
                showTab('movies');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function addSeason() {
            const seasonNum = seasons.length + 1;
            seasons.push({ number: seasonNum, episodes: [] });
            renderSeasons();
        }

        function addEpisode(seasonIndex) {
            const episodeNum = seasons[seasonIndex].episodes.length + 1;
            seasons[seasonIndex].episodes.push({ number: episodeNum });
            renderSeasons();
        }

        function renderSeasons() {
            const container = document.getElementById('seasonsContainer');
            container.innerHTML = '<h3 style="margin-top: 30px;">üéûÔ∏è Temporadas y Episodios</h3>';
            
            seasons.forEach((season, sIndex) => {
                const seasonDiv = document.createElement('div');
                seasonDiv.className = 'episode-group';
                seasonDiv.innerHTML = `
                    <h4>Temporada ${season.number}</h4>
                    <div id="season-${sIndex}-episodes"></div>
                    <button type="button" class="btn add-episode-btn" onclick="addEpisode(${sIndex})">‚ûï A√±adir Episodio</button>
                `;
                container.appendChild(seasonDiv);

                const episodesContainer = seasonDiv.querySelector(`#season-${sIndex}-episodes`);
                season.episodes.forEach((ep, eIndex) => {
                    const epDiv = document.createElement('div');
                    epDiv.style.marginBottom = '15px';
                    epDiv.innerHTML = `
                        <strong>Episodio ${ep.number}</strong>
                        <input type="text" placeholder="T√≠tulo del episodio" id="s${sIndex}e${eIndex}title" style="margin-top: 5px;">
                        <input type="url" placeholder="URL del video" id="s${sIndex}e${eIndex}url" style="margin-top: 5px;">
                        <textarea placeholder="Descripci√≥n" id="s${sIndex}e${eIndex}plot" style="margin-top: 5px; min-height: 60px;"></textarea>
                        <input type="date" placeholder="Fecha de emisi√≥n" id="s${sIndex}e${eIndex}date" style="margin-top: 5px;">
                    `;
                    episodesContainer.appendChild(epDiv);
                });
            });
        }

        async function addMovie(e) {
            e.preventDefault();

            try {
                const fileContent = await getGithubFile(GITHUB_CONFIG);
                const newMovie = createMovieObject();
                const updatedContent = insertMovieIntoCode(fileContent, newMovie);
                await updateGithubFile(GITHUB_CONFIG, updatedContent, 'A√±adir pel√≠cula: ' + newMovie.name);
                
                showAlert('‚úÖ Pel√≠cula a√±adida correctamente a GitHub', 'success');
                document.getElementById('movieForm').reset();
            } catch (err) {
                showAlert('‚ùå Error: ' + err.message, 'error');
            }
        }

        async function addSeries(e) {
            e.preventDefault();

            if (seasons.length === 0) {
                showAlert('‚ö†Ô∏è A√±ade al menos una temporada con episodios', 'error');
                return;
            }

            try {
                const fileContent = await getGithubFile(GITHUB_CONFIG);
                const newSeries = createSeriesObject();
                const updatedContent = insertSeriesIntoCode(fileContent, newSeries);
                await updateGithubFile(GITHUB_CONFIG, updatedContent, 'A√±adir serie: ' + newSeries.series.name);
                
                showAlert('‚úÖ Serie a√±adida correctamente a GitHub', 'success');
                document.getElementById('seriesForm').reset();
                seasons = [];
                renderSeasons();
            } catch (err) {
                showAlert('‚ùå Error: ' + err.message, 'error');
            }
        }

        function createMovieObject() {
            const rating = document.getElementById('movieRating').value || '0';
            return {
                stream_id: Date.now(),
                name: document.getElementById('movieName').value,
                title: document.getElementById('movieName').value,
                stream_icon: document.getElementById('movieIcon').value,
                rating: rating,
                rating_5based: (parseFloat(rating) / 2).toFixed(2),
                container_extension: document.getElementById('movieExt').value,
                direct_source: document.getElementById('movieSource').value,
                plot: document.getElementById('moviePlot').value,
                director: document.getElementById('movieDirector').value,
                actors: document.getElementById('movieActors').value,
                genre: document.getElementById('movieGenre').value,
                releasedate: document.getElementById('movieYear').value
            };
        }

        function createSeriesObject() {
            const seriesId = Date.now();
            const episodesData = {};
            const seasonsData = [];

            seasons.forEach((season, sIndex) => {
                const episodes = [];
                season.episodes.forEach((ep, eIndex) => {
                    const title = document.getElementById(`s${sIndex}e${eIndex}title`).value;
                    const url = document.getElementById(`s${sIndex}e${eIndex}url`).value;
                    const plot = document.getElementById(`s${sIndex}e${eIndex}plot`).value;
                    const date = document.getElementById(`s${sIndex}e${eIndex}date`).value;

                    episodes.push({
                        id: `${seriesId}_${season.number}_${ep.number}`,
                        episode_num: ep.number,
                        title: title || `Episodio ${ep.number}`,
                        container_extension: 'mp4',
                        info: {
                            name: title || `Episodio ${ep.number}`,
                            season: season.number,
                            episode_num: ep.number,
                            air_date: date || new Date().toISOString().split('T')[0],
                            plot: plot || '',
                            duration_secs: (parseInt(document.getElementById('seriesDuration').value) || 45) * 60 + '',
                            duration: (parseInt(document.getElementById('seriesDuration').value) || 45) + ':00',
                            rating: document.getElementById('seriesRating').value || '8.0',
                            cover_big: document.getElementById('seriesCover').value
                        },
                        direct_source: url
                    });
                });

                episodesData[season.number] = episodes;
                seasonsData.push({
                    season_number: season.number,
                    name: `Temporada ${season.number}`,
                    episode_count: episodes.length,
                    cover: document.getElementById('seriesCover').value,
                    cover_big: document.getElementById('seriesCover').value,
                    air_date: episodes[0]?.info?.air_date || new Date().toISOString().split('T')[0]
                });
            });

            return {
                series: {
                    series_id: seriesId,
                    name: document.getElementById('seriesName').value,
                    title: document.getElementById('seriesName').value,
                    cover: document.getElementById('seriesCover').value,
                    plot: document.getElementById('seriesPlot').value,
                    cast: document.getElementById('seriesCast').value,
                    director: document.getElementById('seriesDirector').value,
                    genre: document.getElementById('seriesGenre').value,
                    releaseDate: document.getElementById('seriesRelease').value,
                    rating: document.getElementById('seriesRating').value || '8.0',
                    rating_5based: (parseFloat(document.getElementById('seriesRating').value || '8.0') / 2).toFixed(2),
                    episode_run_time: document.getElementById('seriesDuration').value || '45',
                    category_id: '1',
                    category_ids: [1],
                    backdrop_path: [document.getElementById('seriesCover').value]
                },
                episodes: episodesData,
                seasons: seasonsData
            };
        }

        function insertMovieIntoCode(code, movie) {
            const movieStr = `  {
    stream_id: ${movie.stream_id},
    num: 0,
    name: "${movie.name}",
    title: "${movie.title}",
    stream_type: "movie",
    stream_icon: "${movie.stream_icon}",
    rating: "${movie.rating}",
    rating_5based: ${movie.rating_5based},
    added: "${Math.floor(Date.now() / 1000)}",
    category_id: "1",
    container_extension: "${movie.container_extension}",
    custom_sid: "",
    direct_source: "${movie.direct_source}"
  }`;

            return code.replace(
                /(const movies = \[)/,
                `$1\n${movieStr},`
            );
        }

        function insertSeriesIntoCode(code, data) {
            const seriesStr = `  {
    series_id: ${data.series.series_id},
    name: "${data.series.name}",
    title: "${data.series.title}",
    cover: "${data.series.cover}",
    plot: "${data.series.plot}",
    cast: "${data.series.cast}",
    director: "${data.series.director}",
    genre: "${data.series.genre}",
    releaseDate: "${data.series.releaseDate}",
    rating: "${data.series.rating}",
    rating_5based: ${data.series.rating_5based},
    episode_run_time: "${data.series.episode_run_time}",
    backdrop_path: ${JSON.stringify(data.series.backdrop_path)},
    category_id: "1",
    category_ids: [1]
  }`;

            code = code.replace(/(const series = \[)/, `$1\n${seriesStr},`);

            const episodesStr = `  ${data.series.series_id}: {
    seasons: ${JSON.stringify(data.seasons, null, 6).replace(/\n/g, '\n    ')},
    episodes: ${JSON.stringify(data.episodes, null, 6).replace(/\n/g, '\n    ')}
  }`;

            code = code.replace(/(const seriesEpisodes = {)/, `$1\n${episodesStr},`);

            return code;
        }

        async function getGithubFile(config) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}?ref=${config.branch}`;
            const response = await fetch(url, {
                headers: { 'Authorization': `token ${config.token}` }
            });
            
            if (!response.ok) throw new Error('No se pudo obtener el archivo');
            
            const data = await response.json();
            return atob(data.content);
        }

        async function updateGithubFile(config, content, message) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}`;
            
            const fileResponse = await fetch(url, {
                headers: { 'Authorization': `token ${config.token}` }
            });
            const fileData = await fileResponse.json();

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${config.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    content: btoa(unescape(encodeURIComponent(content))),
                    sha: fileData.sha,
                    branch: config.branch
                })
            });

            if (!response.ok) throw new Error('No se pudo actualizar el archivo');
            return response.json();
        }

        window.onload = checkSession;
    </script>
</body>
</html>